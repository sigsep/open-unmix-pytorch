name: CI
# thanks for @mpariente for copying this workflow
# see: https://help.github.com/en/actions/reference/events-that-trigger-workflows
# Trigger the workflow on push or pull request
on: [push, pull_request]

jobs:
  src-test:
    name: conda-tests
    runs-on: ubuntu-latest

    # Timeout: https://stackoverflow.com/a/59076067/4521646
    timeout-minutes: 10
    steps:
      - uses: conda-incubator/setup-miniconda@v2
        with:
          auto-update-conda: true
          python-version: 3.7
      - name: Conda info
        shell: bash -l {0}
        run: conda info
      - name: Conda list
        shell: pwsh
        run: conda list
      - name: Install dependencies
        run: |
          conda update -q conda
          conda info -a
          conda env create -f scripts/environment-cpu-linux.yml
          source activate umx-cpu
          conda install -c conda-forge sox 
          python -m pip install -e .['tests']
          python --version
          pip --version
          python -m pip list
      - name: Create dummy dataset
        run: |
          chmod +x tests/create_dummy_datasets.sh
          ./tests/create_dummy_datasets.sh
        shell: bash

      - name: Source code tests
        run: |
          py.test tests/test_regression.py -v